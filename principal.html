
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>P√°gina Principal</title>
<style>
  /* ---------- Base ---------- */
  :root{
    --verde:#00897B;
    --verde-osc:#004D40;
    --turq:#00B8D4;
    --bg-grad: linear-gradient(135deg, #00B8D4, #4DD0E1);
  }
  html,body{height:100%; margin:0; font-family:"Segoe UI",sans-serif; background:var(--bg-grad); color:#222;}
  .page{min-height:100%; display:flex; flex-direction:column; align-items:center; padding:18px 12px 40px;}

  .container{width:100%; max-width:1100px;}

  /* ---------- Header ---------- */
  .header{
    background:#fff; border-radius:12px; padding:14px 18px;
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    box-shadow:0 4px 14px rgba(0,0,0,.12);
    flex-wrap:wrap;
  }
  .header-logo{font-size:1.8rem; font-weight:bold; color:var(--verde-osc);}
  .header-saldo{
    display:flex; align-items:center; gap:8px;
    font-size:1.2rem; font-weight:bold;
    background:var(--verde); color:#fff;
    padding:6px 14px; border-radius:10px;
  }
  .header-user{
    font-weight:bold; color:var(--verde-osc);
  }

  /* ---------- Subasta ---------- */
  #subasta{
    margin:22px 0 0; background:#fff;
    border-radius:12px; padding:22px;
    box-shadow:0 6px 18px rgba(0,0,0,.12);
  }
  #subasta h2{margin:0 0 12px; text-align:center; color:var(--verde); font-size:1.5rem;}
  #subasta-contenido{display:flex; gap:32px; justify-content:center; align-items:flex-start;
  flex-wrap:wrap;}
  #producto{width:100%; max-width:420px; text-align:center;}

  /* üÜï Nuevo contenedor para fijar las dimensiones a 300x300 */
  #img-container {
    width: 300px;
    height: 300px;
    margin: 0 auto 10px; /* Centra el contenedor y da margen inferior */
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,.12);
    overflow: hidden; /* Opcional: Recorte suave de la imagen dentro del border-radius */
  }

  /* üÜï Estilo para que la imagen ocupe todo el contenedor y se ajuste sin distorsi√≥n */
  #producto img{
    width: 100%;
    height: 100%;
    object-fit: cover; /* CLAVE: la imagen llena el espacio sin distorsionarse (recorta si es necesario) */
  }
  
  #producto h3{color:var(--verde-osc);
  margin:10px 0 0;}
  
  #ofertas{width:100%; max-width:500px;}
  .tiempo-restante{
    text-align:center; margin:15px 0 25px;
    font-size:1.4rem; font-weight:bold;
    color: #E53935; /* Color rojo para el tiempo */
  }
  .oferta-input{
    display:flex; gap:10px; margin-bottom:15px;
    align-items:center;
  }
  .oferta-input input{
    flex-grow:1; padding:12px; border:1px solid var(--verde);
    border-radius:8px; box-sizing:border-box;
    font-size:1.1rem; text-align:center;
  }
  .oferta-input button{
    padding:12px 20px; background:var(--turq); color:#fff;
    border:none; border-radius:8px; cursor:pointer;
    font-weight:bold; transition:background-color 0.3s;
  }
  .oferta-input button:hover{background:#0097A7;}
  
  #oferta-msg{font-weight:bold; text-align:center; min-height:20px; margin-bottom:15px;}
  
  .tabla-ofertas{
    width:100%; border-collapse:collapse;
    box-shadow:0 2px 8px rgba(0,0,0,.1);
  }
  .tabla-ofertas th, .tabla-ofertas td{
    padding:10px; text-align:left; border-bottom:1px solid #ddd;
  }
  .tabla-ofertas th{
    background:var(--verde-osc); color:#fff;
    text-align:center;
  }
  .tabla-ofertas tr:last-child td{border-bottom:none;}
  .tabla-ofertas td:nth-child(2){font-weight:bold; color:#E53935; text-align:center;}
  .tabla-ofertas td:nth-child(3){font-size:0.9rem; color:#666; text-align:center;}

  /* ---------- Footer (Reclamo) ---------- */
  .footer-reclamo{
    margin-top:30px; padding:20px; background:#fff;
    border-radius:12px; text-align:center;
    box-shadow:0 4px 12px rgba(0,0,0,.12);
  }
  .footer-reclamo h3{color:var(--verde-osc); margin-top:0;}
  .btn-reclamo{
    padding:10px 20px; background:#FF9800; color:#fff;
    border:none; border-radius:8px; cursor:pointer;
    font-weight:bold; transition:background-color 0.3s;
  }
  .btn-reclamo:hover{background:#FB8C00;}

  /* ---------- Modales ---------- */
  .modal {
    display: none; 
    position: fixed;
    z-index: 1000; 
    left: 0; top: 0;
    width: 100%; height: 100%; 
    overflow: auto; 
    background-color: rgba(0,0,0,0.6); 
  }
  .modal-content {
    background-color: #fefefe;
    margin: 10% auto; 
    padding: 25px;
    border-radius: 10px;
    width: 80%; 
    max-width: 400px;
    text-align: center;
    box-shadow: 0 4px 18px rgba(0,0,0,0.3);
  }
  .modal-content h3 {
    color: var(--verde-osc);
    margin-top: 0;
    font-size: 1.4rem;
  }
  .modal-content p {
    margin-bottom: 20px;
    font-size: 1.1rem;
  }
  .modal-footer {
    display: flex;
    justify-content: space-around;
    margin-top: 20px;
  }
  .modal-btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    color: white;
    width: 48%;
  }
  .modal-btn-confirm {
    background: var(--verde);
  }
  .modal-btn-cancel {
    background: #E53935;
  }
  .modal-success-msg {
    color: var(--verde);
    font-weight: bold;
    font-size: 1.2rem;
  }
  .modal-input {
    width: 100%;
    padding: 12px;
    margin: 8px 0;
    border: 1px solid var(--verde); 
    border-radius: 8px;
    box-sizing: border-box;
    text-align: center;
  }

  /* ---------- Media Query para M√≥viles ---------- */
  @media (max-width: 600px) {
    .header {
      flex-direction: column;
      align-items: center;
    }
    .header-logo, .header-user, .header-saldo {
      margin-bottom: 5px;
    }
    #subasta-contenido{
      gap:20px;
    }
    .oferta-input{
      flex-direction:column;
    }
    .oferta-input button, .oferta-input input{
      width:100%;
    }
    .tabla-ofertas th, .tabla-ofertas td{
      font-size:0.9rem;
      padding:8px;
    }
  }

</style>
</head>

<body>

<div class="page">
  <div class="container">

    <header class="header">
      <div class="header-logo">ENDRA</div>
      <div class="header-user">Usuario: <span id="userName">Cargando...</span></div>
      <div class="header-saldo">üí∞ Saldo: <span id="saldo">0</span> Endras</div>
    </header>

    <section id="subasta" aria-label="Subasta del d√≠a">
      <h2>üîπ Subasta del D√≠a</h2>
      <div id="subasta-contenido">
  
        <div id="producto">
          <div id="img-container"> 
            <img id="producto-img" src="" alt="Producto en subasta">
          </div>
          
          <h3 id="producto-titulo">Reloj Inteligente ‚ÄúEndra Fit‚Äù</h3>
        </div>
        <div id="ofertas">
          <div class="tiempo-restante">‚è≥ Tiempo Restante: <span id="timer">00:00:00</span></div>

          <div class="oferta-input">
            <input type="number" id="montoOferta" placeholder="Monto de la Oferta (Endras)" min="1">
            <button onclick="confirmarOferta()">Pujar</button>
          </div>
          <div id="oferta-msg"></div>

          <table class="tabla-ofertas">
            <thead>
              <tr>
                <th>Usuario</th>
                <th>Oferta (Endras)</th>
                <th>Fecha/Hora</th>
              </tr>
            </thead>
            <tbody id="ofertas-body">
              <tr><td colspan="3" style="text-align:center;">Cargando ofertas...</td></tr>
            </tbody>
          </table>
        </div>
        
      </div>
    </section>

    <footer class="footer-reclamo">
      <h3>¬øGanaste un producto?</h3>
      <p>Haz clic en el bot√≥n para iniciar el proceso de reclamo del producto que hayas ganado.</p>
      <button class="btn-reclamo" id="btnReclamar" onclick="mostrarModalReclamo()">Reclamar Producto</button>
    </footer>

  </div>
</div>


<div id="modalReclamo" class="modal" onclick="cerrarModalFuera(event)">
  <div class="modal-content">
    <h3>Confirmar Reclamo</h3>
    <p>Ingresa tu correo y celular actualizados para contactarte.</p>
    
    <input id="correo" class="modal-input" type="email" placeholder="Correo Electr√≥nico" oninput="this.value=this.value.toUpperCase()">
    <input id="celular" class="modal-input" type="text" placeholder="N¬∞ de Celular (9 d√≠gitos)" maxlength="9" oninput="this.value=this.value.replace(/[^0-9]/g,'')">

    <div class="modal-footer">
      <button class="modal-btn modal-btn-cancel" onclick="cerrarModalReclamo()">Cancelar</button>
      <button class="modal-btn modal-btn-confirm" onclick="enviarReclamo()">Enviar Reclamo</button>
    </div>
  </div>
</div>

<div id="modalExito" class="modal" onclick="cerrarModalFuera(event)">
  <div class="modal-content">
    <h3 id="modal-titulo">‚úÖ Reclamo Registrado</h3>
    <p id="modal-mensaje" class="modal-success-msg">Tu solicitud ha sido enviada. Nos contactaremos contigo pronto.</p>
    <div class="modal-footer" style="justify-content:center;">
      <button class="modal-btn modal-btn-confirm" id="modalCerrar" onclick="cerrarModalExito()">Cerrar</button>
    </div>
  </div>
</div>


<script>
/* ----------------- Config ----------------- */
// ‚ö†Ô∏è REEMPLAZA esta URL con la URL de tu proyecto desplegado
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbx1fV6Vt45V6VourCOiHPJBJ78jVc7r6RzpLRRC51sbtJSoS0P9p2aUgcT1hz-Z6zhg/exec";
// üîπ NUEVA CONSTANTE: ID del archivo de la imagen en Google Drive.
// ‚ö†Ô∏è REEMPLAZA 'TU_ID_DE_IMAGEN_DE_DRIVE' con el ID real de tu archivo de Drive.
const PRODUCTO_IMG_ID = "1S2B7XYCK8ki66GSbdNIzS6n2qdaiS9YG"; 

/* Elements */
const saldoSpan = document.getElementById('saldo');
const userNameEl = document.getElementById('userName');
const timerDiv = document.getElementById('timer');
const msg = document.getElementById('msg');
const btnReclamar = document.getElementById('btnReclamar');

const modalReclamo = document.getElementById('modalReclamo');
const modalExito = document.getElementById('modalExito');
const modalCerrar = document.getElementById('modalCerrar');

const correoInput = document.getElementById('correo');
const celularInput = document.getElementById('celular');

/* Subasta elements */
const ofertasBody = document.getElementById('ofertas-body');
const ofertaMsg = document.getElementById('oferta-msg');
const montoInput = document.getElementById('montoOferta');
// üÜï Nueva referencia al elemento de la imagen
const productoImg = document.getElementById('producto-img'); 

let saldoActual = 0;
let datosGuardados = false;
let contadorInterval = null;
let msRestantesGlobal = 0; // Almacena el tiempo restante en ms

/* ----------------- Startup ----------------- */
window.addEventListener('load', () => {
  // Obtener par√°metros de la URL
  const urlParams = new URLSearchParams(window.location.search);
  const userEmail = urlParams.get('email');
  // const userPhone = urlParams.get('phone'); // No usado pero √∫til para referencia

  if (userEmail) {
    userNameEl.textContent = userEmail.toUpperCase();
    // üîπ NUEVA L√çNEA: Establecer la fuente de la imagen al cargar.
    if (PRODUCTO_IMG_ID) {
        // La URL de la imagen ahora apunta a la Web App con action=image y el ID de Drive
        productoImg.src = `${WEB_APP_URL}?action=image&id=${PRODUCTO_IMG_ID}`;
    }
    obtenerSaldoYRestriccion();
    cargarOfertas();
  } else {
    // Si no hay par√°metros, redirigir al login (o mostrar error)
    userNameEl.textContent = 'ERROR';
    mostrarModalExito('Error', 'No se pudo cargar la informaci√≥n del usuario. Redirigiendo...', false);
    setTimeout(() => {
        // Redirigir a la p√°gina de login (asumiendo que est√° en la ra√≠z)
        window.location.href = window.location.origin; 
    }, 2000);
  }
});

/* ----------------- Funciones de Saldo y Tiempo ----------------- */
async function obtenerSaldoYRestriccion() {
  const usuario = userNameEl.textContent;
  if (usuario === 'Cargando...' || usuario === 'ERROR') return;

  try {
    const fd = new FormData();
    fd.append('action', 'obtenerSaldoYRestriccion');
    fd.append('usuario', usuario);

    const res = await fetch(WEB_APP_URL, { method: 'POST', body: fd });
    const data = await res.json();

    if (data && data.success) {
      saldoActual = Number(data.saldo || 0);
      saldoSpan.textContent = saldoActual.toLocaleString('es-ES');
      msRestantesGlobal = Number(data.msRestantes || 0);
      
      // Detener el contador anterior si existe
      if (contadorInterval) {
        clearInterval(contadorInterval);
      }
      
      // Iniciar el nuevo contador
      iniciarContador(msRestantesGlobal);

    } else {
      console.error('Error al obtener saldo y restricci√≥n:', data.message);
      saldoSpan.textContent = 'Error';
    }
  } catch (err) {
    console.error('Error de conexi√≥n al obtener saldo:', err);
    saldoSpan.textContent = 'Error';
  }
}

function iniciarContador(msRestantes) {
  let endTime = new Date().getTime() + msRestantes;

  const updateTimer = () => {
    const ahora = new Date().getTime();
    let remaining = endTime - ahora;

    if (remaining < 0) {
      remaining = 0;
      clearInterval(contadorInterval);
      timerDiv.textContent = "¬°FINALIZADO!";
      ofertaMsg.textContent = "La subasta ha finalizado.";
      ofertaMsg.style.color = '#E53935';
      
      // Deshabilitar la entrada de oferta
      montoInput.disabled = true;
      document.querySelector('.oferta-input button').disabled = true;
      return;
    }

    const h = Math.floor(remaining / (1000 * 60 * 60));
    const m = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
    const s = Math.floor((remaining % (1000 * 60)) / 1000);

    const format = (num) => String(num).padStart(2, '0');
    timerDiv.textContent = `${format(h)}:${format(m)}:${format(s)}`;
  };

  updateTimer();
  contadorInterval = setInterval(updateTimer, 1000);
}

/* ----------------- Funciones de Oferta ----------------- */
function confirmarOferta() {
  const monto = Number(montoInput.value);
  if (monto <= 0) {
    ofertaMsg.style.color = '#E53935';
    ofertaMsg.textContent = '‚ùå Por favor, ingresa un monto v√°lido.';
    return;
  }
  if (monto > saldoActual) {
    ofertaMsg.style.color = '#E53935';
    ofertaMsg.textContent = `‚ùå Saldo insuficiente. Tienes ${saldoActual} Endras.`;
    return;
  }
  
  if (msRestantesGlobal <= 0) {
      ofertaMsg.style.color = '#E53935';
      ofertaMsg.textContent = "La subasta ha finalizado. No puedes pujar.";
      return;
  }
  
  // Si todo es v√°lido, procede a enviar la oferta
  ofrecerEndra(monto);
}


async function ofrecerEndra(monto) {
  // Enviar oferta al servidor
  try{
    const fd = new FormData();
    fd.append('action','oferta');
    // enviamos usuario en may√∫scula para consistencia
    const usuario = userNameEl.textContent ? userNameEl.textContent.toUpperCase() : 'USUARIO';
    fd.append('usuario', usuario);
    fd.append('monto', monto);

    const res = await fetch(WEB_APP_URL,{method:'POST', body:fd});
    const data = await res.json();
    
    // El servidor ya descont√≥ el saldo, as√≠ que solo actualizamos localmente si fue exitoso
    if (data && data.success) {
      ofertaMsg.style.color = 'var(--verde-osc)';
      ofertaMsg.textContent = data.message;
      montoInput.value = '';
      
      // Refrescar saldo y ofertas
      obtenerSaldoYRestriccion(); 
      cargarOfertas();
    } else {
      ofertaMsg.style.color = '#E53935';
      ofertaMsg.textContent = (data && data.message) ? data.message : 'Error al registrar oferta.';
      // Si falla por saldo, el saldo local ya es correcto, pero refrescamos por si acaso.
      obtenerSaldoYRestriccion();
    }
  }catch(err){
    console.error('Error ofrecerEndra',err);
    ofertaMsg.style.color = '#E53935';
    ofertaMsg.textContent = 'Error de conexi√≥n.';
    obtenerSaldoYRestriccion();
  }
}

async function cargarOfertas() {
  ofertasBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Cargando...</td></tr>';
  
  try {
    const fd = new FormData();
    fd.append('action', 'listarOfertas');
    
    // Usamos GET si es posible, o POST si el servidor solo acepta POST.
    // Usaremos POST para consistencia con el servidor (doPost con action).
    const res = await fetch(WEB_APP_URL, { method: 'POST', body: fd });
    const data = await res.json();
    
    ofertasBody.innerHTML = ''; // Limpiar
    
    if (data && data.success && data.ofertas && data.ofertas.length > 0) {
      data.ofertas.forEach(oferta => {
        const row = ofertasBody.insertRow();
        row.insertCell(0).textContent = oferta.usuario;
        row.insertCell(1).textContent = Number(oferta.monto).toLocaleString('es-ES');
        row.insertCell(2).textContent = oferta.fecha;
      });
    } else {
      ofertasBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">A√∫n no hay ofertas registradas.</td></tr>';
    }
  } catch(err) {
    console.error('Error cargarOfertas', err);
    ofertasBody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#E53935;">Error al cargar ofertas.</td></tr>';
  }
}


/* ----------------- Funciones de Reclamo (Modal) ----------------- */
function mostrarModalReclamo() {
  correoInput.value = '';
  celularInput.value = '';
  modalReclamo.style.display = 'block';
}

function cerrarModalReclamo() {
  modalReclamo.style.display = 'none';
}

function mostrarModalExito(titulo, mensaje, esExito = true) {
    document.getElementById('modal-titulo').textContent = titulo;
    document.getElementById('modal-mensaje').textContent = mensaje;
    document.getElementById('modal-titulo').style.color = esExito ? 'var(--verde-osc)' : '#E53935';
    document.getElementById('modal-mensaje').style.color = esExito ? 'var(--verde-osc)' : '#E53935';
    modalExito.style.display = 'block';
}

function cerrarModalExito() {
  modalExito.style.display = 'none';
}

function cerrarModalFuera(event) {
    if (event.target === modalReclamo) {
        cerrarModalReclamo();
    }
    if (event.target === modalExito) {
        cerrarModalExito();
    }
}

async function enviarReclamo() {
  const correo = correoInput.value.trim().toUpperCase();
  const celular = celularInput.value.trim();
  const usuario = userNameEl.textContent;

  if (!correo || celular.length !== 9) {
    mostrarModalExito('Atenci√≥n', '‚ùå Ingresa un correo y un celular de 9 d√≠gitos v√°lidos.', false);
    return;
  }

  // Deshabilitar bot√≥n para evitar env√≠os m√∫ltiples
  document.querySelector('#modalReclamo .modal-btn-confirm').disabled = true;
  
  try {
    const fd = new FormData();
    fd.append('action', 'reclamo');
    fd.append('usuario', usuario);
    fd.append('correo', correo);
    fd.append('celular', celular);

    const res = await fetch(WEB_APP_URL, { method: 'POST', body: fd });
    const data = await res.json();
    
    cerrarModalReclamo(); // Cerrar el modal de entrada de datos

    if (data && data.success) {
      mostrarModalExito('‚úÖ Reclamo Registrado', data.message, true);
      btnReclamar.disabled = true; // Deshabilitar despu√©s de reclamar
    } else {
      mostrarModalExito('Error al Reclamar', (data && data.message) ? data.message : 'Error de servidor.', false);
    }
  } catch (err) {
    console.error('Error enviarReclamo', err);
    cerrarModalReclamo();
    mostrarModalExito('Error de Conexi√≥n', 'No se pudo conectar con el servidor.', false);
  } finally {
     // Re-habilitar bot√≥n al finalizar, sea √©xito o error
    document.querySelector('#modalReclamo .modal-btn-confirm').disabled = false;
  }
}
</script>

</body>
</html>
