// =========================================================
// CONFIGURACI√ìN GLOBAL
// =========================================================
const SS_ID = 'TU_ID_DE_HOJA_DE_CALCULO'; // üîπ Reemplaza con el ID real de tu hoja
const HOJA_USUARIOS = 'Usuarios';
const HOJA_OFERTAS = 'Ofertas';
const TIEMPO_ESPERA_HORAS = 5;
const MONEDAS_RECLAMO = 10;

// =========================================================
// FUNCI√ìN PRINCIPAL DE ENTRADA (API)
// =========================================================
function doPost(e) {
  const params = e.parameter;
  const action = params.action;

  if (action === 'login') return handleLogin(params);
  else if (action === 'reclamo') return handleReclamo(params);
  else if (action === 'oferta') return handleOferta(params);
  else if (action === 'listarOfertas') return handleListarOfertas();
  else return ContentService.createTextOutput(JSON.stringify({ success: false, error: 'Acci√≥n no v√°lida' }));
}

// =========================================================
// FUNCI√ìN LOGIN
// =========================================================
function handleLogin(params) {
  const email = params.email?.trim();
  const phone = params.phone?.trim();

  if (!email || !phone) {
    return ContentService.createTextOutput(JSON.stringify({ success: false, message: "Datos incompletos" }));
  }

  const ss = SpreadsheetApp.openById(SS_ID);
  const sh = ss.getSheetByName(HOJA_USUARIOS);
  const data = sh.getDataRange().getValues();
  const header = data.shift();

  const idxEmail = header.indexOf("Email");
  const idxPhone = header.indexOf("Celular");
  const idxNombre = header.indexOf("Nombres");
  const idxSaldo = header.indexOf("Saldo");

  let usuario = data.find(r => r[idxEmail] === email && r[idxPhone] === phone);
  if (!usuario) {
    sh.appendRow([new Date(), '', '', '', email, phone, 0, '', '']);
    usuario = [new Date(), '', '', '', email, phone, 0];
  }

  const saldo = usuario[idxSaldo] || 0;
  const nombre = usuario[idxNombre] || '';

  return ContentService.createTextOutput(
    JSON.stringify({ success: true, nombre, saldo })
  ).setMimeType(ContentService.MimeType.JSON);
}

// =========================================================
// FUNCI√ìN RECLAMO DE ENDRA
// =========================================================
function handleReclamo(params) {
  const email = params.email?.trim();
  const phone = params.phone?.trim();
  const nombre = params.nombres?.trim() || '';
  const aP = params.apellidoP?.trim() || '';
  const aM = params.apellidoM?.trim() || '';
  const check = params.check || 'false';

  const ss = SpreadsheetApp.openById(SS_ID);
  const sh = ss.getSheetByName(HOJA_USUARIOS);
  const data = sh.getDataRange().getValues();
  const header = data.shift();

  const idxEmail = header.indexOf("Email");
  const idxPhone = header.indexOf("Celular");
  const idxSaldo = header.indexOf("Saldo");
  const idxLast = header.indexOf("Ultimo Reclamo");
  const idxNombre = header.indexOf("Nombres");
  const idxApP = header.indexOf("Apellido Paterno");
  const idxApM = header.indexOf("Apellido Materno");

  let rowIndex = data.findIndex(r => r[idxEmail] === email && r[idxPhone] === phone);
  if (rowIndex === -1) return ContentService.createTextOutput(JSON.stringify({ success: false, message: "Usuario no encontrado" }));

  const row = rowIndex + 2; // Compensar encabezado
  const saldo = Number(sh.getRange(row, idxSaldo + 1).getValue() || 0);
  const last = sh.getRange(row, idxLast + 1).getValue();
  const now = new Date();

  // Si es solo verificaci√≥n inicial (no reclamo)
  if (check === 'true') {
    let waitSeconds = 0;
    if (last && now - last < TIEMPO_ESPERA_HORAS * 3600000) {
      waitSeconds = Math.floor((TIEMPO_ESPERA_HORAS * 3600000 - (now - last)) / 1000);
    }
    const nombresCompletos = [sh.getRange(row, idxNombre + 1).getValue(),
                              sh.getRange(row, idxApP + 1).getValue(),
                              sh.getRange(row, idxApM + 1).getValue()].filter(Boolean).join(' ');
    return ContentService.createTextOutput(JSON.stringify({
      success: true,
      saldo,
      waitSeconds,
      datosGuardados: !!nombresCompletos,
      nombresCompletos
    }));
  }

  // Verifica tiempo de espera
  if (last && now - last < TIEMPO_ESPERA_HORAS * 3600000) {
    const falta = Math.floor((TIEMPO_ESPERA_HORAS * 3600000 - (now - last)) / 1000);
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      message: "Debes esperar a√∫n",
      waitSeconds: falta
    }));
  }

  // Guarda datos personales si no existen
  if (nombre && !sh.getRange(row, idxNombre + 1).getValue()) {
    sh.getRange(row, idxNombre + 1).setValue(nombre);
    sh.getRange(row, idxApP + 1).setValue(aP);
    sh.getRange(row, idxApM + 1).setValue(aM);
  }

  // Suma monedas
  const nuevoSaldo = saldo + MONEDAS_RECLAMO;
  sh.getRange(row, idxSaldo + 1).setValue(nuevoSaldo);
  sh.getRange(row, idxLast + 1).setValue(now);

  const nombresCompletos = [nombre, aP, aM].filter(Boolean).join(' ');

  return ContentService.createTextOutput(JSON.stringify({
    success: true,
    message: "Reclamo exitoso",
    monto: MONEDAS_RECLAMO,
    saldo: nuevoSaldo,
    nombresCompletos
  }));
}

// =========================================================
// SUBASTA GLOBAL
// =========================================================
function handleOferta(params) {
  const ss = SpreadsheetApp.openById(SS_ID);
  const sh = ss.getSheetByName(HOJA_OFERTAS);

  const usuario = params.get('usuario');
  const monto = Number(params.get('monto'));

  if (!usuario || !monto) {
    return ContentService.createTextOutput(JSON.stringify({ success: false }));
  }

  // Guardamos la oferta
  sh.appendRow([new Date(), usuario, monto]);

  // Tambi√©n podemos descontar saldo en hoja Usuarios
  descontarSaldo(usuario, monto);

  return ContentService.createTextOutput(JSON.stringify({ success: true }));
}

function handleListarOfertas() {
  const ss = SpreadsheetApp.openById(SS_ID);
  const sh = ss.getSheetByName(HOJA_OFERTAS);
  const data = sh.getDataRange().getValues();
  data.shift();

  const ofertas = data.map(r => ({ usuario: r[1], monto: Number(r[2]) }));
  ofertas.sort((a, b) => b.monto - a.monto);

  return ContentService.createTextOutput(
    JSON.stringify({ success: true, ofertas: ofertas.slice(0, 5) })
  );
}

// =========================================================
// DESCONTAR SALDO AL OFERTAR
// =========================================================
function descontarSaldo(nombreUsuario, monto) {
  const ss = SpreadsheetApp.openById(SS_ID);
  const sh = ss.getSheetByName(HOJA_USUARIOS);
  const data = sh.getDataRange().getValues();
  const header = data.shift();

  const idxNombre = header.indexOf("Nombres");
  const idxSaldo = header.indexOf("Saldo");

  const i = data.findIndex(r => (r[idxNombre] || '').toString().toUpperCase() === nombreUsuario.toUpperCase());
  if (i === -1) return;

  const row = i + 2;
  const saldoActual = Number(sh.getRange(row, idxSaldo + 1).getValue() || 0);
  const nuevoSaldo = Math.max(0, saldoActual - monto);
  sh.getRange(row, idxSaldo + 1).setValue(nuevoSaldo);
}
