<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>P√°gina Principal</title>
<style>
  /* ---------- Base ---------- */
  :root{
    --verde:#00897B;
    --verde-osc:#004D40;
    --turq:#00B8D4;
    --bg-grad: linear-gradient(135deg, #00B8D4, #4DD0E1);
  }
  html,body{height:100%; margin:0; font-family:"Segoe UI",sans-serif; background:var(--bg-grad); color:#222;}
  .page{min-height:100%; display:flex; flex-direction:column; align-items:center;
  padding:18px 12px 40px;}

  .container{width:100%; max-width:1100px;}

  /* ---------- Header ---------- */
  .header{
    background:#fff; border-radius:12px;
  padding:14px 18px;
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    box-shadow:0 4px 14px rgba(0,0,0,.12);
    flex-wrap:wrap;
  }
  .header-left{display:flex; align-items:center; gap:12px; min-width:0;}
  #userName{margin:0; color:var(--verde);
  font-weight:700; font-size:1.2rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .balance{font-weight:700; color:var(--verde-osc); font-size:1rem; text-align:center;}
  .actions{display:flex; gap:10px; align-items:center;}
  button{background:var(--verde); color:#fff; border:0; padding:10px 14px;
  border-radius:8px; cursor:pointer; font-weight:700;}
  button:disabled{background:#B0BEC5; cursor:not-allowed;}
  .timer{font-size:0.9rem; color:var(--verde-osc); margin-top:4px; text-align:center;}
  #msg{margin-top:10px; text-align:center;
  font-weight:700;}

  /* ---------- Subasta ---------- */
  #subasta{
    width:100%; max-width:950px; margin:28px auto 0; background:rgba(255,255,255,0.95);
    border-radius:12px; padding:22px;
  box-shadow:0 6px 18px rgba(0,0,0,.12);
  }
  #subasta h2{margin:0 0 12px; text-align:center; color:var(--verde); font-size:1.5rem;}
  #subasta-contenido{display:flex; gap:32px; justify-content:center; align-items:flex-start;
  flex-wrap:wrap;}
  #producto{width:100%; max-width:420px; text-align:center;}
  /* üëà CAMBIO: Tama\u00f1o fijo y escalado de imagen */
  #producto img{
    width:300px; /* Ancho fijo predeterminado */
    height:300px; /* Alto fijo predeterminado */
    object-fit: contain; /* Para que la imagen entera sea visible sin recortar */
    border-radius:12px; 
    box-shadow:0 4px 12px rgba(0,0,0,.12);
    margin: 0 auto; /* Centrar imagen */
    display: block; /* Necesario para que margin: auto funcione */
  }
  #producto h3{color:var(--verde-osc);
  margin:10px 0 0;}
  #ofertas{flex:1; min-width:260px; max-width:420px; background:#fff; border-radius:12px; padding:16px; box-shadow:0 4px 10px rgba(0,0,0,.06);}
  #ofertas h4{margin:0 0 8px; text-align:center;
  color:var(--verde);}
  table{width:100%; border-collapse:collapse; font-size:0.95rem;}
  th{background:#E0F2F1; color:var(--verde-osc); padding:8px; text-align:left;}
  td{padding:8px; border-bottom:1px solid #eee;}
  .input-full{width:100%; padding:10px; margin-top:8px; border-radius:8px;
  border:1px solid var(--turq);}
  .btn-full{width:100%; margin-top:10px; padding:10px;}
  #oferta-msg{margin-top:8px; text-align:center; font-weight:700;}

  /* ---------- Modales ---------- */
  .modal{display:none; position:fixed;
  inset:0; background:rgba(0,0,0,0.45); z-index:9998; justify-content:center; align-items:center;}
  .modal.show{display:flex;}
  .modal-content{background:#fff; border-radius:12px; padding:20px; width:92%; max-width:420px;
  box-shadow:0 8px 24px rgba(0,0,0,.25);}
  .modal-content h3,.modal-content h2{color:var(--verde); margin:0 0 10px; text-align:center;}
  .modal-footer{display:flex; gap:10px;
  margin-top:12px;}
  .modal-footer button{flex:1;}

  /* ---------- Responsive ---------- */
  @media (max-width:720px){
    .header{padding:12px;}
    #subasta{padding:16px;
  margin:18px 0;}
    #subasta-contenido{gap:14px;}
  }
</style>
</head>
<body>
  <div class="page">
    <div class="container">

      <div class="header" id="headerMain">
        <div class="header-left">
          <h2 id="userName">USUARIO</h2>
        </div>

        <div style="display:flex;flex-direction:column;align-items:center;">
          <div class="balance">Endra üí† <span id="saldo">0</span></div>
          <div id="timer" class="timer"></div>
      
    </div>

        <div class="actions">
          <button id="btnReclamar" onclick="reclamarEndra()">Reclamar Endra</button>
          <button id="btnCerrar" onclick="abrirModalCerrar()">Cerrar sesi√≥n</button>
        </div>
      </div>

      <div id="msg"></div>

      <section id="subasta" aria-label="Subasta del d√≠a">
        <h2>üîπ Subasta del D√≠a</h2>
        <div id="subasta-contenido">
    
          
     <div id="producto">

            <img id="producto-img" src="https://drive.google.com/uc?export=view&id=1S2B7XYCK8ki66GSbdNIzS6n2qdaiS9YG" alt="Producto en subasta">

            <h3 id="producto-titulo">Reloj Inteligente ‚ÄúEndra Fit‚Äù</h3>

          </div>
          
          <div id="ofertas">
            <h4>üèÜ Top 5 Ofertas</h4>
         
       <table aria-label="Tabla de ofertas">
              <thead><tr><th>Usuario</th><th style="text-align:right">Oferta (Endra)</th></tr></thead>
              <tbody id="ofertas-body"><tr><td colspan="2" style="text-align:center;padding:12px;">Sin ofertas a√∫n</td></tr></tbody>
            </table>

            <div style="margin-top:12px;">
              <label for="montoOferta" style="color:var(--verde-osc);font-weight:700">Tu oferta (Endra):</label>
              <input id="montoOferta" 
  class="input-full" type="number" min="1" placeholder="Ingresa cantidad">
              <button class="btn-full" onclick="ofrecerEndra()">Ofrecer</button>
              <p id="oferta-msg"></p>
            </div>
          </div>
        </div>
      </section>

    </div>
  </div>

  <div class="modal" id="modalReclamo" role="dialog" aria-modal="true">
    <div class="modal-content">
      
  <h3>Completa tus datos</h3>
      <input id="nombre" class="input-full" placeholder="NOMBRES" />
      <input id="apellidoP" class="input-full" placeholder="APELLIDO PATERNO" />
      <input id="apellidoM" class="input-full" placeholder="APELLIDO MATERNO" />
      <input id="correo" class="input-full" disabled />
      <input id="celular" class="input-full" disabled />
      <div class="modal-footer">
        <button onclick="confirmarReclamo()">Confirmar</button>
        <button onclick="cerrarModal()">Cancelar</button>
      </div>
    </div>
  </div>

  <div class="modal" 
  id="modalExito" role="dialog" aria-modal="true">
    <div class="modal-content">
      <h2>üéâ Reclamo Exitoso</h2>
      <p id="textoExito" style="text-align:center;color:var(--verde-osc);font-weight:700"></p>
      <div style="margin-top:12px;"><button onclick="cerrarModalExito()">Cerrar</button></div>
    </div>
  </div>

  <div class="modal" id="modalCerrar" role="dialog" aria-modal="true">
    <div class="modal-content">
      <h2>¬øCerrar sesi√≥n?</h2>
      <p style="text-align:center;color:var(--verde-osc)">¬øEst√°s seguro que deseas salir?</p>
      <div class="modal-footer">
        <button onclick="cerrarModalCerrar()" style="background:#00897B">Cancelar</button>
        <button onclick="confirmarCerrarSesion()" style="background:#E53935">Cerrar 
  sesi√≥n</button>
      </div>
    </div>
  </div>

<script>
/* ----------------- Config ----------------- */
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbx1fV6Vt45V6VourCOiHPJBJ78jVc7r6RzpLRRC51sbtJSoS0P9p2aUgcT1hz-Z6zhg/exec";
/* Elements */
const saldoSpan = document.getElementById('saldo');
const userNameEl = document.getElementById('userName');
const timerDiv = document.getElementById('timer');
const msg = document.getElementById('msg');
const btnReclamar = document.getElementById('btnReclamar');

const modalReclamo = document.getElementById('modalReclamo');
const modalExito = document.getElementById('modalExito');
const modalCerrar = document.getElementById('modalCerrar');

const correoInput = document.getElementById('correo');
const celularInput = document.getElementById('celular');

/* Subasta elements */
const ofertasBody = document.getElementById('ofertas-body');
const ofertaMsg = document.getElementById('oferta-msg');
const montoInput = document.getElementById('montoOferta');
let saldoActual = 0;
let datosGuardados = false;
let contadorInterval = null;
/* Read URL params (email, phone) */
const urlParams = new URLSearchParams(window.location.search);
const email = urlParams.get('email') || '';
const phone = urlParams.get('phone') || '';

/* Inicializa valores visibles */
if (email) correoInput.value = email;
if (phone) celularInput.value = phone;
userNameEl.textContent = email ? email.split('@')[0].toUpperCase() : "USUARIO";

/* ---------- Startup ---------- */
window.addEventListener('load', () => {
  obtenerSaldoYRestriccion();
  cargarOfertas();
});
/* ---------- Obtener saldo y tiempo restante del servidor ---------- */
async function obtenerSaldoYRestriccion(){
  try{
    const fd = new FormData();
  fd.append('action','reclamo');
    fd.append('email', email);
    fd.append('phone', phone);
    fd.append('check', 'true');

    const res = await fetch(WEB_APP_URL, { method:'POST', body: fd });
  const data = await res.json();

    if (data && data.success) {
      saldoActual = Number(data.saldo || 0);
  saldoSpan.textContent = saldoActual;
      datosGuardados = !!data.datosGuardados;
      if (data.nombresCompletos) userNameEl.textContent = data.nombresCompletos.toUpperCase();
  if (data.waitSeconds && data.waitSeconds > 0) {
        desactivarBotonTemporalSegundos(data.waitSeconds);
  } else {
        btnReclamar.disabled = false;
  }
    } else {
      // En caso la API devuelva success=false (no encontrado), permitimos que el usuario vea el bot√≥n (pero backend controla)
      btnReclamar.disabled = false;
  }
  }catch(err){
    console.error('Error al obtener saldo:',err);
    btnReclamar.disabled = false;
  }
}

/* ---------- Reclamar Endra (abrir modal o directamente confirmar) ---------- */
function reclamarEndra(){
  if (datosGuardados) {
    // Si ya tiene datos guardados, confirmar de inmediato
    confirmarReclamo();
  } else {
    // Rellenar campos correo/celular visibles y abrir modal
    correoInput.value = email ||
  '';
    celularInput.value = phone || '';
    modalReclamo.classList.add('show');
    modalReclamo.style.display = 'flex';
  }
}
function cerrarModal(){ modalReclamo.classList.remove('show'); modalReclamo.style.display='none';
  }
/* ---------- Confirmar reclamo: env\u00eda nombres (si existen) y procesa reclamo ---------- */
async function confirmarReclamo(){
  // Si datos no guardados, requerir nombres
  const nombre = document.getElementById('nombre').value.trim().toUpperCase();
  const aP = document.getElementById('apellidoP').value.trim().toUpperCase();
  const aM = document.getElementById('apellidoM').value.trim().toUpperCase();
  if (!datosGuardados && (!nombre || !aP || !aM)) {
    alert('Completa tus nombres y apellidos');
  return;
  }

  try{
    const fd = new FormData();
    fd.append('action','reclamo');
    fd.append('email', email);
    fd.append('phone', phone);
    fd.append('nombres', nombre);
    fd.append('apellidoP', aP);
    fd.append('apellidoM', aM);

    const res = await fetch(WEB_APP_URL,{method:'POST', body:fd});
  const data = await res.json();

  if (data && data.success) {
      saldoActual = Number(data.saldo || saldoActual);
      saldoSpan.textContent = saldoActual;
      datosGuardados = true;
      cerrarModal();
  mostrarModalExito(data.monto || 10, data.saldo);
      // desactivar bot\u00f3n por 5 horas (servidor ya guard\u00f3 TS_MS, pero ponemos contador fix)
      desactivarBotonTemporalSegundos(5 * 3600);
  } else {
      // Si mensaje de servidor indica tiempo restante, mostrar en msg y activar contador con waitSeconds si existe
      msg.style.color = '#E53935';
  msg.textContent = data && data.message ? data.message : 'No se pudo procesar reclamo';
      if (data && data.waitSeconds) desactivarBotonTemporalSegundos(data.waitSeconds);
  }
  }catch(err){
    console.error('Error confirmarReclamo',err);
    msg.style.color = '#E53935';
    msg.textContent = 'Error de conexi\u00f3n.';
  }
}

/* ---------- Modal \u00e9xito ---------- */
function mostrarModalExito(monto, saldo){
  const texto = document.getElementById('textoExito');
  texto.innerHTML = `Has ganado <b>${monto}</b> Endra.<br>Saldo total: <b>${saldo}</b> Endra.`;
  modalExito.classList.add('show');
  modalExito.style.display='flex';
}
function cerrarModalExito(){
  modalExito.classList.remove('show');
  modalExito.style.display='none';
  obtenerSaldoYRestriccion(); // Recargar saldo por si el reclamo cambi\u00f3 los datos
}

/* ---------- Desactivar bot\u00f3n y mostrar contador (segundos) ---------- */
function desactivarBotonTemporalSegundos(segundos) {
  btnReclamar.disabled = true;
  clearInterval(contadorInterval);

  let segundosRestantes = segundos;

  function actualizarContador() {
    if (segundosRestantes <= 0) {
      clearInterval(contadorInterval);
      timerDiv.textContent = 'Listo para reclamar!';
      btnReclamar.disabled = false;
      return;
    }

    const horas = Math.floor(segundosRestantes / 3600);
    const minutos = Math.floor((segundosRestantes % 3600) / 60);
    const segs = segundosRestantes % 60;

    const h = String(horas).padStart(2, '0');
    const m = String(minutos).padStart(2, '0');
    const s = String(segs).padStart(2, '0');

    timerDiv.textContent = `Disponible en: ${h}:${m}:${s}`;
    segundosRestantes--;
  }

  actualizarContador();
  contadorInterval = setInterval(actualizarContador, 1000);
}


/* ---------- Cerrar sesi\u00f3n ---------- */
function abrirModalCerrar(){
  modalCerrar.classList.add('show');
  modalCerrar.style.display = 'flex';
}
function cerrarModalCerrar(){
  modalCerrar.classList.remove('show');
  modalCerrar.style.display = 'none';
}
function confirmarCerrarSesion(){
  cerrarModalCerrar();
  // Redirigir al index (ajusta la ruta si la tienes en otra carpeta)
  window.location.href = window.location.origin + '/subasta-ciega-diaria/index.html';
}


/* ================== SUBASTA ================== */

/* Carga top5 desde servidor (Sheets) */
async function cargarOfertas(){
  try{
    const fd = new FormData();
  fd.append('action','listarOfertas');
    const res = await fetch(WEB_APP_URL,{method:'POST', body:fd});
    const data = await res.json();
    if (data && data.success) {
      renderOfertas(data.ofertas || []);
  }
  }catch(err){
    console.error('Error cargarOfertas',err);
  }
}

function renderOfertas(ofertas){
  ofertasBody.innerHTML = '';
  if (!ofertas || ofertas.length===0){
    ofertasBody.innerHTML = `<tr><td colspan="2" style="text-align:center;padding:12px;">Sin ofertas a\u00fan</td></tr>`;
    return;
  }
  ofertas.forEach(o=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="max-width:220px; overflow:hidden; text-overflow:ellipsis;">${o.usuario}</td> <td style="text-align:right">${o.monto}</td>`;
    ofertasBody.appendChild(tr);
  });
}

/* Enviar oferta al servidor */
async function ofrecerEndra(){
  ofertaMsg.textContent = '';
  const monto = Number(montoInput.value);

  if (isNaN(monto) || monto <= 0) {
    ofertaMsg.style.color = '#E53935';
    ofertaMsg.textContent = 'Ingresa un monto de oferta v\u00e1lido (mayor a 0).';
    return;
  }

  if (monto > saldoActual) {
    ofertaMsg.style.color = '#E53935';
    ofertaMsg.textContent = `Tu saldo (${saldoActual} Endra) es insuficiente.`;
    return;
  }

  // Descontar saldo localmente
  saldoActual -= monto;
  saldoSpan.textContent = saldoActual;

  // Enviar oferta al servidor
  try{
    const fd = new FormData();
    fd.append('action','oferta');
    // enviamos usuario en may\u00fascula para consistencia
    const usuario = userNameEl.textContent ? userNameEl.textContent.toUpperCase() : 'USUARIO';
    fd.append('usuario', usuario);
    fd.append('monto', monto);

    const res = await fetch(WEB_APP_URL,{method:'POST', body:fd});
    const data = await res.json();
    if (data && data.success) {
      ofertaMsg.style.color = 'var(--verde-osc)';
      ofertaMsg.textContent = '‚úÖ Oferta registrada correctamente.';
      montoInput.value = '';
      // recargar top 5
      cargarOfertas();
    } else {
      ofertaMsg.style.color = '#E53935';
      ofertaMsg.textContent = (data && data.message) ? data.message : 'Error al registrar oferta.';
      // si falla, revertir saldo local para evitar p\u00e9rdida visual
      // (mejor pedir recarga del saldo desde servidor, pero revertimos aqu\u00ed)
      // recargar saldo desde servidor:
      obtenerSaldoYRestriccion();
    }
  }catch(err){
    console.error('Error ofrecerEndra',err);
    ofertaMsg.style.color = '#E53935';
    ofertaMsg.textContent = 'Error de conexi\u00f3n.';
    obtenerSaldoYRestriccion();
  }
}

</script>
</body>
</html>
